<html ng-app="app">
<head>
  <title>Sales Management</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css">
</head>
<body>

<ng-view></ng-view>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.25/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.25/angular-route.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.25/angular-resource.min.js"></script>

<script type="text/ng-template" id="/items.html">
<h1>Items for sale</h1>
  <ul>
    <li ng-repeat="item in items">
    	${{item.price}} |
      <a href="#/{{item._id}}">{{item.name}}</a> |
      {{item.description}}<br>
      <span>{{item.sold ? 'Item has been sold' : 'Item is available'}}</span>
      <button ng-click="remove($index)">remove</button>
    </li>
  </ul>
  <form>
    <h2>Add a new item</h2>
    <ul>
    <li><label>Item Name</label>
    <input type="text" name="name" ng-model="newItem.name"></li>
    <li><label>Item Description</label>
    <input type="text" name="description" ng-model="newItem.description"></li>    
    <li><label>Item Price</label>
    <input type="number" step="0.01" name="price" ng-model="newItem.price"></li>
    <button ng-click="save()">Add to list</button>
    </ul>
  </form>
</script>

<script type="text/ng-template" id="/itemDetails.html">
  <h1>{{ item.name }}</h1>
  <h2>{{ item.description}}</h2>
  <p>Sale Price: ${{ item.price }}</p>
  Item sold?: <input type="checkbox" ng-model="item.sold"><br>

  <button ng-click="update()">update</button>
  <button ng-click="remove()">remove</button>
  <a href="/">Cancel</a>
</script>

<script>
  angular.module('app', ['ngRoute', 'ngResource'])

    .factory('Items', ['$resource', function($resource){
    	return $resource('/items/:id', null, {
    		'update': {method: 'PUT'}
    	});
    }])

    .controller('ItemController', ['$scope', 'Items', function ($scope, Items) {
    	$scope.items = Items.query();
      
      $scope.save = function(){
        if(!$scope.newItem || $scope.newItem.length < 1) return;
        var item = new Items({ name: $scope.newItem.name, 
                               description: $scope.newItem.description, 
                               sold: false, 
                               price: $scope.newItem.price});

        item.$save(function(){
          $scope.items.push(item);
          $scope.newItem = "";
        });
      }

      $scope.remove = function(index){
      	var item = $scope.items[index];
      	console.log(item);
      	Items.remove({id: item._id}, function(){
      		$scope.items.splice(index, 1);
      		});	
      	}
    }])

  .controller('ItemDetailsCtrl', ['$scope', '$routeParams', 'Items', '$location', function ($scope, $routeParams, Items, $location) {
    $scope.item = Items.get({id: $routeParams.id });
    $scope.update = function(){
      Items.update({id: $scope.item._id}, $scope.item, function(){
        $location.url('/');
      });
    }

    $scope.remove = function(){
      Items.remove({id: $scope.item._id}, function(){
        $location.url('/');
      });
    }
  }])
    .config(['$routeProvider', function ($routeProvider) {
      $routeProvider
        .when('/', {
          templateUrl: '/items.html',
          controller: 'ItemController'
        })
        .when('/:id', {
          templateUrl: '/itemDetails.html',
          controller: 'ItemDetailsCtrl'
        })
    }]);
</script>

</body>
</html>